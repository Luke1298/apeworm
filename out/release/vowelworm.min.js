(function(){/*


 VowelWorm.decibelsToLinear licensed under the following:

 Copyright (C) 2010, Google Inc. All rights reserved.

 Redistribution and use in source and binary forms, with or without
 modification, are permitted provided that the following conditions
 are met:
 1.  Redistributions of source code must retain the above copyright
    notice, this list of conditions and the following disclaimer.
 2.  Redistributions in binary form must reproduce the above copyright
    notice, this list of conditions and the following disclaimer in the
    documentation and/or other materials provided with the distribution.

 THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS'' AND ANY
 EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

 END VowelWorm.decibelsToLinear LICENSE


 Hanning window code taken from http://wiki.scipy.org/Cookbook/SignalSmooth
 both constant values and code preparing data for convolution



 Savitsky-Golay filter (VowelWorm.savitzkyGolay)
 adapted from http://wiki.scipy.org/Cookbook/SavitzkyGolay



 VowelWorm._toFrequency method developed with help from kr1 at
 {@link http://stackoverflow.com/questions/14789283/what-does-the-fft-data-in-the-web-audio-api-correspond-to}


 Psuedo-inverse function from S?bastien Loisel, found in a Google Groups
 discussion {@link https://groups.google.com/d/msg/numericjs/spFVVp1Fy60/6wuN3-vl1IkJ}
 S?bastien linked to work he had done in the NumericJS Workshop, found here
 {@link http://www.numericjs.com/workshop.php?link=aacea378e9958c51af91f9eadd5bc7446e0c4616fc7161b384e5ca6d4ec036c7}



 VowelWorm.instance.prototype.setStream helper functions borrow heavily from
 Chris Wilson's pitch detector, under the MIT license.
 See https://github.com/cwilso/pitchdetect



 VowelWorm.instance.prototype.getMFCCs derived from David Ireland's code at
 https://github.com/Maxwell79/mfccExtractor under Version 2 (1991) of the GNU
 General Public License.

*/
window.VowelWorm=window.VowelWorm||{};
(function(f,p){function u(a){for(var c=0;c<a.length;c++)a[c]=Math.abs(a[c]);return a}function s(a,c){for(var e=0;e<a.length;e++)a[e]+=c;return a}function w(a){for(var c=[],e=0;e<arguments.length;e++)for(var b=0;b<arguments[e].length;b++)c.push(arguments[e][b]);return c}function t(a){for(var c=[],e=a.length-1;-1<e;e--)c.push(a[e]);return c}var x=new window.AudioContext,r=[],n={},v=[75,61];f._HANNING_WINDOW={61:new Float32Array([0,0.00273905,0.0109262,0.02447174,0.04322727,0.0669873,0.0954915,0.12842759,
0.1654347,0.20610737,0.25,0.29663168,0.3454915,0.39604415,0.44773577,0.5,0.55226423,0.60395585,0.6545085,0.70336832,0.75,0.79389263,0.8345653,0.87157241,0.9045085,0.9330127,0.95677273,0.97552826,0.9890738,0.99726095,1,0.99726095,0.9890738,0.97552826,0.95677273,0.9330127,0.9045085,0.87157241,0.8345653,0.79389263,0.75,0.70336832,0.6545085,0.60395585,0.55226423,0.5,0.44773577,0.39604415,0.3454915,0.29663168,0.25,0.20610737,0.1654347,0.12842759,0.0954915,0.0669873,0.04322727,0.02447174,0.0109262,0.00273905,
0]),75:new Float32Array([0,0.00180126,0.00719204,0.01613353,0.02856128,0.04438575,0.06349294,0.08574518,0.11098212,0.13902195,0.16966264,0.20268341,0.23784636,0.27489813,0.31357176,0.35358861,0.39466037,0.43649109,0.4787794,0.5212206,0.56350891,0.60533963,0.64641139,0.68642824,0.72510187,0.76215364,0.79731659,0.83033736,0.86097805,0.88901788,0.91425482,0.93650706,0.95561425,0.97143872,0.98386647,0.99280796,0.99819874,1,0.99819874,0.99280796,0.98386647,0.97143872,0.95561425,0.93650706,0.91425482,0.88901788,
0.86097805,0.83033736,0.79731659,0.76215364,0.72510187,0.68642824,0.64641139,0.60533963,0.56350891,0.5212206,0.4787794,0.43649109,0.39466037,0.35358861,0.31357176,0.27489813,0.23784636,0.20268341,0.16966264,0.13902195,0.11098212,0.08574518,0.06349294,0.04438575,0.02856128,0.01613353,0.00719204,0.00180126,0])};f.Normalization={barkScale:function(a){0==a&&(a=1);return 26.81/(1+1960/a)-0.53}};f.decibelsToLinear=function(a){return Math.pow(10,0.05*a)};f.normalize=function(a,c){if(!a.length)return[];if(void 0===
c||null===c)c=f.Normalization.barkScale;if("function"!==typeof c)throw Error("Expecting a function as a method for VowelWorm.normalize");if(!(c.name in f.Normalization))throw Error("Method '"+c.name+"' is not part of VowelWorm.Normalization and cannot be used for normalization.");var e=null,b=null;switch(c){case this.Normalization.barkScale:e=c(a[2])-c(a[1]),b=c(a[2])-c(a[0])}return null===e||null===b?[]:[e,b]};f.hann=function(a,c){if("undefined"===typeof f._HANNING_WINDOW[c])throw Error("No precomputed Hanning Window values found for "+
c);for(var e=[],b=c-1;0<b;b--)e.push(a[b]);for(b=0;b<a.length;b++)e.push(a[b]);for(b=a.length-1;b>a.length-c;b--)e.push(a[b]);for(var d=f._HANNING_WINDOW[c],k=0,g=[],b=0;b<d.length;b++)k+=d[b];for(b=0;b<d.length;b++)g[b]=d[b]/k;return f.convolve(g,e)};f.savitzkyGolay=function(a,c,e){c=Math.abs(parseInt(c,10));e=Math.abs(parseInt(e,10));var b=e+1;e=(c-1)/2;c=[];for(var d=-e;d<e+1;d++){for(var k=[],g=0;g<b;g++)k.push(Math.pow(d,g));c.push(k)}k=p.svd(c);g=k.S[0];b=k.U;d=k.S;k=k.V;c=Math.max(c.length,
c[0].length)*p.epsilon*g;for(var h=d.length,g=Array(h),h=h-1;-1!==h;h--)g[h]=d[h]>c?1/d[h]:0;c=p.dot(p.dot(k,p.diag(g)),p.transpose(b))[0];b=[];b=a.subarray?a.subarray(1,e+1):a.slice(1,e+1);b=t(b);b=s(b,-a[0]);b=u(b);d=a[0];for(k=0;k<b.length;k++)b[k]=-b[k]+d;d=[];d=a.subarray?a.subarray(-e-1,-1):a.slice(-e-1,-1);d=t(d);d=s(d,-a[a.length-1]);d=u(d);d=s(d,a[a.length-1]);a=w(b,a,d);c=t(c);e=[];return e=f.convolve(c,a)};f.convolve=function(a,c){var e=[],b=null,d=null;a.length>c.length?(b=c,d=a):(b=a,
d=c);for(var f=d.length-b.length+1,g=0;g<f;g++){for(var h=0,l=b.length,m=0;m<b.length;m++)h+=b[l-1-m]*d[m+g];e.push(h)}return e};f.AUDIO=1;f.VIDEO=2;f.STREAM=3;f.REMOTE_URL=4;f._toFrequency=function(a,c,e){return c/2/(e/2)*a};f._peakHeight=function(a,c){for(var e=c[a],b=null,d=null,f=null,g=a-1;0<=g&&!(null!==f&&c[g]>f);g--)f=c[g],b=e-f;f=null;for(g=a+1;g<c.length&&!(null!==f&&c[g]>f);g++)f=c[g],d=e-f;e=null===b?+d:null===d?+b:b<d?b:d;return 0>e?0:e};f.instance=function(a){var c=this;this._context=
x;this._analyzer=this._context.createAnalyser();this._sourceNode=null;this._analyzer.fftSize=2048;this._buffer=new Float32Array(this._analyzer.fftSize/2);this._audioBuffer=null;a&&this.setStream(a);Object.keys(n).forEach(function(a){c[a]={};n[a].call(c[a],c)});r.push(this)};f.HANNING_SHIFT=32;f.DEFAULT_MAX_FORMANT_MALE=5E3;f.DEFAULT_MAX_FORMANT_FEMALE=5500;f.DEFAULT_MAX_FORMANT_CHILD=8E3;f.instance.prototype=Object.create(f);f.instance.constructor=f.instance;var y=f.instance.prototype;f.module=function(a,
c){if(void 0!==y[a]||void 0!==n[a])throw Error('Cannot define a VowelWorm module with the name "'+a+'": a property with that name already exists. May I suggest "'+a+'_kewl_sk8brdr_98" instead?');if("function"!==typeof c)throw Error("No callback function submitted.");n[a]=c;r.forEach(function(c){c[a]={};n[a].call(c[a],c)})};f.removeModule=function(a){void 0!==n[a]&&(delete n[a],r.forEach(function(c){delete c[a]}))};f.instance.prototype.mode=null;f.instance.prototype.getFFT=function(){this._analyzer.getFloatFrequencyData(this._buffer);
return this._buffer};f.instance.prototype.setStream=function(a){if("string"===typeof a)this._loadFromURL(a);else if("object"===typeof a&&"MediaStream"===a.constructor.name)this._loadFromStream(a);else if(a&&(a instanceof window.Audio||"AUDIO"===a.tagName))this._loadFromAudio(a);else if(a&&"VIDEO"===a.tagName)this._loadFromVideo(a);else throw Error("VowelWorm.instance.setStream only accepts URL strings, instances of MediaStream (as from getUserMedia), or <audio> elements");};f.instance.prototype._loadFromStream=
function(a){this.mode=this.STREAM;this._context.createMediaStreamSource(a).connect(this._analyzer)};f.instance.prototype._getPeaks=function(a,c,e){for(var b=[],d,f,g,h=0;h<a.length;h++){var l=this._toFrequency(h,c,e),m=b.length+1;switch(m){case 1:if(100>l)continue;break;case 2:if(600>l||150>l-b[0])continue;break;case 3:if(1500>l||500>l-b[1])continue;break;default:return}d=a[h-1]||0;f=a[h]||0;g=a[h+1]||0;if(f>d&&f>g&&0.1<=this._peakHeight(h,a)&&(b.push(l),3===m))break}return b};f.instance.prototype.getSampleRate=
function(){switch(this.mode){case this.REMOTE_URL:return this._sourceNode.buffer.sampleRate;case this.AUDIO:case this.VIDEO:return 44100;case this.STREAM:return this._context.sampleRate;default:throw Error("Current mode has no method for sample rate");}};f.instance.prototype.getFFTSize=function(){return this._analyzer.fftSize};f.instance.prototype.getMFCCs=function(a){var c=null,e=void 0===a.toLinearMagnitude?!0:!!a.toLinearMagnitude,c=a.fft?a.fft:this.getFFT();if(e)for(var b=0;b<c.length;b++)c[b]=
f.decibelsToLinear(c[b]);else{for(var e=[],d=0;d<c.length;d++)e[d]=Math.abs(c[d]);c=e}var e=[],d=a.filterBanks,b=2*c.length,k=a.minFreq,g=a.maxFreq,h=a.sampleRate||this.getSampleRate();a=1125*Math.log(1+g/700);var g=1125*Math.log(1+k/700),l=(a-g)/(d+1),k=[];for(a=0;a<d+2;a++){var m=700*(Math.exp((g+a*l)/1125)-1);k.push(Math.floor(b*m/h))}for(d=1;d<k.length-1;d++){var l=[],m=f._toFrequency(k[d-1],h,b),n=f._toFrequency(k[d],h,b),p=f._toFrequency(k[d+1],h,b);for(a=0;a<1+b/2;a++){var q=f._toFrequency(a,
h,b),g=null,g=q<=n&&q>=m?(q-m)/(n-m):q>n&&q<=p?(p-q)/(p-n):0;l.push(g)}e.push(l)}h=[];k=[];for(d=0;d<e.length;d++){for(b=a=g=0;b<e[d].length-1;b++)g+=e[d][b]*c[a++];h.push(Math.log(g))}for(d=0;d<e.length;d++){for(b=a=g=0;b<h.length;b++)g+=h[b]*Math.cos(d*(a++-0.5)*Math.PI/e.length);g/=e.length;k.push(g)}return k};f.instance.prototype.getFormants=function(a,c){if(2!==arguments.length&&0!==arguments.length)throw Error("Invalid arguments. Function must be called either as  getFormants(data, sampleRate) or getFormants()");
var e=null;a?e=2*a.length:(a=this.getFFT(),e=this.getFFTSize(),c=this.getSampleRate());for(var b=0;b<v.length;b++){var d=this.hann(a,v[b]).slice(this.HANNING_SHIFT),d=this._getPeaks(d,c,e);if(!(100>d[0]||1E3<d[0]||d[0]>=d[1]||600>d[1]||3E3<d[1]||d[1]>=d[2]||1500>d[2]||5E3<d[2]))return d}return[]};f.instance.prototype.destroy=function(){var a=r.indexOf(this);-1!==a&&r.splice(a,1);for(var c in this)this.hasOwnProperty(c)&&delete this[c]};f.instance.prototype._loadFromURL=function(a){function c(a){b.mode=
this.REMOTE_URL;b._audioBuffer=a;b._resetSourceNode()}function e(){throw Error("Could not parse audio data. Make sure the file ("+a+") you are passing to setStream or VowelWorm.instance is a valid audio file.");}var b=this,d=new XMLHttpRequest;d.open("GET",a,!0);d.responseType="arraybuffer";d.onerror=function(){throw Error("Tried to load audio file at '"+a+"', but a netowrk error occurred: "+d.statusText);};d.onload=function(){if(200!==d.status)throw Error("Tried to load audio file at '"+a+"', but the server returned "+
d.status+" "+d.statusText+". Make sure the URL you are passing to setStream or VowelWorm.instance is correct");b._context.decodeAudioData(this.response,c,e)};d.send()};f.instance.prototype._loadFromAudio=function(a){console.warn("Cannot determine sample rate. Setting as 44100");this.mode=this.AUDIO;this._sourceNode=this._context.createMediaElementSource(a);this._sourceNode.connect(this._analyzer);this._analyzer.connect(this._context.destination)};f.instance.prototype._loadFromVideo=function(a){console.warn("Cannot determine sample rate. Setting as 44100");
this.mode=this.VIDEO;this._sourceNode=this._context.createMediaElementSource(a);this._sourceNode.connect(this._analyzer);this._analyzer.connect(this._context.destination)};f.instance.prototype._resetSourceNode=function(){this._sourceNode=this._context.createBufferSource();this._sourceNode.buffer=this._audioBuffer;this._sourceNode.connect(this._analyzer)}})(window.VowelWorm,window.numeric);}).call(this);
